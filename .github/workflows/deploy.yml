name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger Render Deployment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID_BACKEND: ${{ secrets.RENDER_SERVICE_ID_BACKEND }}
          RENDER_SERVICE_ID_FRONTEND: ${{ secrets.RENDER_SERVICE_ID_FRONTEND }}
        run: |
          if [ -z "$RENDER_API_KEY" ]; then
            echo "‚ö†Ô∏è  RENDER_API_KEY not set - relying on Render auto-deploy"
            echo "üöÄ Render will auto-deploy from main branch"
            echo "Check status at: https://dashboard.render.com"
          else
            echo "üöÄ Triggering manual deployment via Render API..."

            # Deploy backend
            if [ -n "$RENDER_SERVICE_ID_BACKEND" ]; then
              curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID_BACKEND/deploys" \
                -H "Authorization: Bearer $RENDER_API_KEY" \
                -H "Content-Type: application/json"
              echo "‚úÖ Backend deployment triggered"
            fi

            # Deploy frontend
            if [ -n "$RENDER_SERVICE_ID_FRONTEND" ]; then
              curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID_FRONTEND/deploys" \
                -H "Authorization: Bearer $RENDER_API_KEY" \
                -H "Content-Type: application/json"
              echo "‚úÖ Frontend deployment triggered"
            fi
          fi

      - name: Deployment Summary
        run: |
          echo "üì¶ Deployment Summary"
          echo "===================="
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Services:"
          echo "  - Database (PostgreSQL)"
          echo "  - Backend API"
          echo "  - Frontend Web App"
          echo ""
          echo "Monitor deployment at: https://dashboard.render.com"
